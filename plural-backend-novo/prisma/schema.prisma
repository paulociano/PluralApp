// Arquivo: prisma/schema.prisma
// Versão Final Verificada

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  name              String
  password          String
  username          String             @unique
  bio               String?
  createdAt         DateTime           @default(now())
  arguments         Argument[]
  votes             Vote[]
  notifications     Notification[]     @relation("Recipient") // Notificações recebidas
  triggered         Notification[]     @relation("Trigger")   // Notificações que este usuário causou
  reportsMade       Report[]           @relation("Reporter") // Denúncias que o usuário fez
  favoriteArguments FavoriteArgument[]
  badges            UserBadge[]
  points            Int                @default(0)
}

model Topic {
  id          String         @id @default(cuid())
  title       String
  description String
  createdAt   DateTime       @default(now())
  category    TopicCategory?
  arguments   Argument[]
}

model Argument {
  id               String             @id @default(cuid())
  content          String
  type             ArgType
  createdAt        DateTime           @default(now())
  votesCount       Int                @default(0)
  replyCount       Int                @default(0)
  author           User               @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId         String
  topic            Topic              @relation(fields: [topicId], references: [id], onDelete: Cascade)
  topicId          String
  parentArgument   Argument?          @relation("Replies", fields: [parentArgumentId], references: [id], onDelete: SetNull)
  parentArgumentId String?
  replies          Argument[]         @relation("Replies")
  votes            Vote[]
  reports          Report[]           @relation("ReportedArgument")
  favoritedBy      FavoriteArgument[]

  Notification Notification[] @relation("OriginArgumentNotifications")
}

model Vote {
  id         String   @id @default(cuid())
  type       VoteType
  userId     String
  argumentId String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  argument   Argument @relation(fields: [argumentId], references: [id], onDelete: Cascade)

  @@unique([userId, argumentId])
}

model FavoriteArgument {
  id         String   @id @default(cuid())
  userId     String
  argumentId String
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  argument Argument @relation(fields: [argumentId], references: [id], onDelete: Cascade)

  @@unique([userId, argumentId])
}

model Notification {
  id               String           @id @default(cuid())
  type             NotificationType
  isRead           Boolean          @default(false)
  createdAt        DateTime         @default(now())
  recipient        User             @relation("Recipient", fields: [recipientId], references: [id], onDelete: Cascade)
  recipientId      String
  triggerUser      User             @relation("Trigger", fields: [triggerUserId], references: [id], onDelete: Cascade)
  triggerUserId    String
  originArgumentId String
  originArgument   Argument         @relation("OriginArgumentNotifications", fields: [originArgumentId], references: [id], onDelete: Cascade)
}

model Report {
  id                 String       @id @default(cuid())
  reason             ReportReason
  notes              String?
  status             ReportStatus @default(PENDING)
  createdAt          DateTime     @default(now())
  reporter           User         @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reporterId         String
  reportedArgument   Argument     @relation("ReportedArgument", fields: [reportedArgumentId], references: [id], onDelete: Cascade)
  reportedArgumentId String

  @@unique([reporterId, reportedArgumentId])
}

model Badge {
  id          String       @id @default(cuid())
  name        String       @unique // Ex: "Iniciante Curioso"
  description String       // Ex: "Criou seu primeiro argumento."
  icon        String       // Ex: "FiFeather" (nome do ícone)
  createdAt   DateTime     @default(now())
  users       UserBadge[]
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
}

enum ArgType {
  PRO
  CONTRA
  NEUTRO
}

enum VoteType {
  UPVOTE
  DOWNVOTE
}

enum NotificationType {
  NEW_REPLY
}

enum ReportReason {
  SPAM
  OFFENSIVE
  DISINFORMATION
  OTHER
}

enum ReportStatus {
  PENDING
  RESOLVED
  DISMISSED
}

enum TopicCategory {
  TECNOLOGIA
  SOCIEDADE
  CULTURA
  POLITICA
  MEIO_AMBIENTE
  CIENCIA
  OUTRO
}